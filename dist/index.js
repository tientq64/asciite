function ownKeys(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),s.push.apply(s,a)}return s}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(s),!0).forEach(function(t){_defineProperty(e,t,s[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ownKeys(Object(s)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))})}return e}function _defineProperty(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var indexOf=[].indexOf,modulo=function(e,t){return(+e%(t=+t)+t)%t};!function(){var e;e=class extends React.Component{constructor(e){super(e),autoBind(this),this.chrs="+ * - = ~ ! ? @ # $ % & \" ' ` ° . : , ; ( ) { } [ ] < > / \\ | _ ¯ … ‡ © ^ 0 1 2 3 4 5 6 7 8 9 A B C D E F G H I J K L M N O P Q R S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z".split(" "),this.codeShiftMap={BackQuote:"`",Digit1:"1",Digit2:"2",Digit3:"3",Digit4:"4",Digit5:"5",Digit6:"6",Digit7:"7",Digit8:"8",Digit9:"9",Digit0:"0",Minus:"-",Equal:"=",BracketLeft:"[",BracketRight:"]",Backslash:"\\",Semicolon:";",Quote:"'",Comma:",",Period:".",Slash:"/"},this.w=47,this.h=13,this.frames=[],this.totalDuration=0,this.models={},this.modelIncrId=0,this.tool=this.chrs[0],this.text=null,this.sel=null,this.clipboard=[],this.grid=null,this.page=null,this.item=null,this.hovItem=null,this.col=null,this.frameIndexRun=-1,this.oldPageRun=null,this.timeoutRun=0,this.animateRun=null,this.button=0,this.key="",this.g=null,this.boot()}boot(){var e;for(e of Object.getOwnPropertyNames(this.constructor.prototype))e.startsWith("class")&&(t=>(this[t]=this[e],this[e]=function(){return classNames(this[t](...arguments))}.bind(this)))(Symbol(e))}addFrame(e,t=1){var s,a,i;null==e&&(e={}),a="frame"===(null!=(i=this.page)?i.type:void 0)?t+this.frames.indexOf(this.page):this.frames.length,s=_objectSpread({duration:1,w:this.w,h:this.h,items:[]},e,{type:"frame",thumbnail:null}),this.updateTotalDuration(),this.updatePageThumbnail(s),this.frames.splice(a,0,s),this.updateTotalDuration(),this.setPage(s)}addModel(e){var t,s;null==e&&(e={}),s=_objectSpread({w:9,h:9,items:[]},e,{type:"model",id:t=this.modelIncrId++,thumbnail:null}),this.updatePageThumbnail(s),this.models[t]=s,this.setPage(s)}makeSel(e=[]){return{items:e,hadItems:e}}removeModel(e){var t,s,a,i,l;for(s of(e!==this.page&&e!==this.tool||(l=Object.values(this.models),a=1+_.findIndex(l,{id:e.id}),t=e===this.page&&this.setPage||this.setTool,(i=l[a]||l[a-2])?t(i):"frame"!==this.page.type&&this.setPage(this.frames[0])),this.frames))indexOf.call(s.items,e)>=0&&(_.pull(s.items,e),this.updatePageThumbnail(s));delete this.models[e.id],this.setState({})}removeFrame(e){var t,s;e===this.page&&(s=1+this.frames.indexOf(e),(t=this.frames[s]||this.frames[s-2])?this.setPage(t):this.addFrame()),_.pull(this.frames,e),this.updateTotalDuration()}setPage(e){this.page!==e&&(this.page=e,this.sel=null,"model"===e.type&&"model"===this.tool.type&&this.setTool(this.chrs[0]),this.updateGrid(e),this.setState({},()=>{"model"===e.type?(this.refs.w.value=e.w,this.refs.h.value=e.h):(this.refs.w.value=e.w,this.refs.h.value=e.h,this.refs.duration.value=e.duration)}))}setTool(e){e&&(this.tool=e),this.setState({})}isValidPagePos(e,t=this.page){return this.isValidPageXY(e.x,e.y,t)}isValidPageXY(e,t,s=this.page){return 0<=e&&e<s.w&&0<=t&&t<s.h}getSpreadPageItems(e=this.page){return e.items.flatMap(t=>{switch(!1){case!t.model:return t.model.items.filter(e=>this.isValidPagePos(e,t.model)).map(e=>({x:e.x+t.x,y:e.y+t.y,chr:e.chr,item:t})).filter(t=>this.isValidPagePos(t,e));case!t.text:return this.extractText(t,e);default:return t}})}duplicateFrame(e,t=1){null==e&&(e=this.page),this.addFrame(_objectSpread({},e,{items:e.items.map(e=>_objectSpread({},e))}),t)}convertFrameToModel(e=this.page){var t,s,a,i,l,r,h,n;for(s of(l=r=Infinity,a=i=-Infinity,n=[],t=[],e.items))s.chr?(s.x<l&&(l=s.x),s.y<r&&(r=s.y),s.x>a&&(a=s.x),s.y>i&&(i=s.y),n.push(s)):t.push(s);if(n.length){for(s of(e.items=t,this.updatePageThumbnail(e),n))s.x-=l,s.y-=r;h={w:a-l+1,h:i-r+1,items:n},this.addModel(h)}}clickChr(e){this.setTool(e),this.setState({})}mouseDownEnterUpCol(e,t){var s,a,i,l,r,h,n,o,m,c;switch(s=this.col&&e.x-this.col.x||0,a=this.col&&e.y-this.col.y||0,this.col=e,this.item=this.col.items[0],this.button){case 1:switch(this.key){case"Alt":this.text||"model"===this.page.type||(this.text={x:e.x,y:e.y,text:""},setTimeout(this.refs.textarea.focus.bind(this.refs.textarea)));break;case"Shift":for(t&&(null==this.sel&&(this.sel=this.makeSel()),this.sel.x=e.x,this.sel.y=e.y,this.sel.hadItems=this.sel.items),this.sel.x0=Math.min(e.x,this.sel.x),this.sel.y0=Math.min(e.y,this.sel.y),this.sel.x1=Math.max(e.x,this.sel.x),this.sel.y1=Math.max(e.y,this.sel.y),l=[],c=r=this.sel.y0,n=this.sel.y1;r<=n;c=r+=1)for(m=h=this.sel.x0,o=this.sel.x1;h<=o;m=h+=1)for(i of this.grid[c][m].items)i.item&&({item:i}=i),indexOf.call(l,i)<0&&l.push(i);this.sel.items=_.union(this.sel.hadItems,l);break;default:if(this.sel)for(i of this.sel.items)i.x+=s,i.y+=a;else this.text||("model"===this.tool.type?((i=e.orgItems.find(e=>e.model===this.tool))&&_.pull(this.page.items,i),i={x:e.x-Math.floor(this.tool.w/2),y:e.y-Math.floor(this.tool.h/2),model:this.tool}):((i=e.orgItems.find(e=>e.chr))&&_.pull(this.page.items,i),i={x:e.x,y:e.y,chr:this.tool}),this.page.items.push(i));this.updatePageThumbnail()}break;case 2:this.item&&(this.setTool(this.item.chr),this.setState({}));break;case 3:this.item&&(_.pull(this.page.items,this.item.item||this.item),this.updatePageThumbnail());break;default:switch(this.key){case"Shift":this.hovItem=this.item}}this.updateGrid()}mouseDownModel(e){switch(this.button){case 1:"model"===this.page.type||this.tool===e?this.setPage(e):this.setTool(e);break;case 3:this.removeModel(e)}}mouseDownFrame(e){switch(this.button){case 1:this.setPage(e);break;case 3:this.removeFrame(e)}this.setState({})}mouseEnterCol(e){this.mouseDownEnterUpCol(e)}onWheelGrid(e){var t;this.tool.type||(t=this.chrs.indexOf(this.tool),t=modulo(t+Math.sign(e.deltaY),this.chrs.length),this.setTool(this.chrs[t]),this.setState({}))}onChangePageW(e){e.target.validity.valid&&(this.page.w=e.target.valueAsNumber,this.updatePageThumbnail(),this.updateGrid())}onChangePageH(e){e.target.validity.valid&&(this.page.h=e.target.valueAsNumber,this.updatePageThumbnail(),this.updateGrid())}onChangePageDuration(e){e.target.validity.valid&&(this.page.duration=e.target.valueAsNumber,this.updateTotalDuration())}onChangeTextarea(e){this.text.text=e.target.value,this.updateGrid()}onBlurTextarea(e){var t,s;this.text&&((s=this.formatTextText(this.text.text.trimEnd()))&&(t={x:this.text.x,y:this.text.y,text:s},this.page.items.push(t)),setTimeout(()=>{this.text=null}),this.refs.textarea.value="",this.updatePageThumbnail(),this.updateGrid())}onMouseDown(e){this.button=e.which}onMouseUp(){this.sel&&(this.sel.hadItems=null,this.sel.items.length||(this.sel=null)),this.button=0,this.col&&this.mouseDownEnterUpCol(this.col)}onKeyDown(e){var t,s,a,i,l,r,h,n,o,m,c;if(!e.repeat){if(this.updateKey(e),({key:h,ctrlKey:a,altKey:s,metaKey:n}=e),i="input"===(c=(t=document.activeElement).localName)||"textarea"===c||"select"===c,a||s||n||1!==h.length)switch(this.key){case"Shift":this.hovItem=this.item;break;case"Escape":i?t.blur():this.sel&&(this.sel=null);break;case"Tab":i&&t===this.refs.textarea&&e.preventDefault();break;case"Ctrl+C":case"Ctrl+X":if(!i&&this.sel){for(l of(o=m=Infinity,this.sel.items))l.x<o&&(o=l.x),l.y<m&&(m=l.y);this.clipboard=this.sel.items.map(e=>_objectSpread({},e,{x:e.x-o,y:e.y-m})),"Ctrl+X"===this.key&&(_.pullAll(this.page.items,this.sel.items),this.sel=null),this.updatePageThumbnail()}break;case"Ctrl+V":i||this.clipboard.length&&(r=this.clipboard.map(e=>_objectSpread({},e)),this.page.items.push(...r),this.sel=this.makeSel(r),this.updatePageThumbnail());break;case"Ctrl+S":e.preventDefault(),localStorage.asciite=this.exportData(!0);break;case"Ctrl+Shift+S":e.preventDefault(),this.saveAsFile(this.exportData(),`edit-${Date.now()}.json`);break;case"Ctrl+Shift+Alt+S":e.preventDefault(),this.saveAsFile(this.publishData(),`film-${Date.now()}.json`)}else indexOf.call(this.chrs,h)>=0&&this.setTool(h);this.updateGrid()}}onKeyUp(){this.key="",this.hovItem=null,this.updateGrid()}onBlur(e){e.target===e.currentTarget&&(this.onMouseUp(),this.onKeyUp())}onContextMenu(e){e.preventDefault()}formatTextText(e){return e.replace(/\.{3}/g,"…")}extractText(e,t,s){var a,i,l,r,h,n;for(a of(i=[],({x:h,y:n,text:l}=e),l=this.formatTextText(l),s&&(l+="|"),l))"\n"===a?(({x:h}=e),n++):/\s/.test(a)?h++:(r={x:h++,y:n,chr:a,item:e},i.push(r));return s&&(r.cursor=!0),i}exportData(e){var t,s,a;return a=Object.values(this.models),s=this.frames.map(e=>[e.items.map(e=>[e.x,e.y,e.text?`'${e.text}`:e.model?a.indexOf(e.model):e.chr]),e.duration]),a=a.map(e=>[e.items.map(e=>[e.x,e.y,e.chr]),e.w,e.h]),t=JSON.stringify([a,s]),e&&(t=LZString.compress(t)),t}publishData(){var e,t;return t=[],e=this.frames.map(e=>[e.items.map(e=>{var s;return[e.x,e.y,e.text?`'${e.text}`:e.model?(s=t.indexOf(e.model),s<0?(t.push(e.model),t.length-1):s):e.chr]}),e.duration]),t=t.map(e=>[e.items.map(e=>[e.x,e.y,e.chr]),e.w,e.h]),JSON.stringify([t,e])}importData(e,t){var s,a,i,l,r,h;if(e){for(t&&(e=LZString.decompress(e)),e=JSON.parse(e),this.modelIncrId=e[0].length,this.models={},s=a=0,i=(h=e[0]).length;a<i;s=++a)l={type:"model",id:s,w:(r=h[s])[1],h:r[2],items:r[0].map(e=>({x:e[0],y:e[1],chr:e[2]})),thumbnail:null},this.updatePageThumbnail(l),this.models[s]=l;return this.frames=e[1].map(e=>{var t;return t={type:"frame",duration:e[1],w:this.w,h:this.h,items:e[0].map(e=>{var t;return t={x:e[0],y:e[1]},"number"==typeof e[2]?t.model=this.models[e[2]]:1===e[2].length?t.chr=e[2]:t.text=e[2].slice(1),t})},this.updatePageThumbnail(t),t}),this.updateTotalDuration(),!0}}saveAsFile(e,t){var s,a,i;s=new Blob([e]),i=URL.createObjectURL(s),(a=document.createElement("a")).href=i,a.download=t,a.click(),URL.revokeObjectURL(i)}updateKey(e){var t,s;({key:s,code:t}=e),this.key="","Control"===s||"Shift"===s||"Alt"===s||"Meta"===s?this.key="Control"===s?"Ctrl":s:(e.ctrlKey&&(this.key+="Ctrl+"),e.shiftKey&&(this.key+="Shift+"),e.altKey&&(this.key+="Alt+"),e.metaKey&&(this.key+="Meta+"),e.shiftKey&&(s=this.codeShiftMap[t]||s),1===s.length&&(s=s.toUpperCase()),this.key+=s)}updateTotalDuration(){this.totalDuration=_.sumBy(this.frames,"duration"),this.setState({})}updatePageThumbnail(e=this.page){var t,s;for(t of(this.g.canvas.width=e.w,this.g.canvas.height=2*e.h,this.g.clearRect(0,0,e.w,2*e.h),s=this.getSpreadPageItems(e),this.g.fillStyle="#fff",s))this.g.fillRect(t.x,2*t.y,1,2);e.thumbnail=this.g.canvas.toDataURL()}updateGrid(e=this.page){var t,s,a,i,l,r,h,n,o,m;for(s of(this.grid=_.times(e.h,t=>_.times(e.w,e=>({x:e,y:t,items:[],orgItems:[],bgColor:"black",color:"white"}))),a=this.getSpreadPageItems(e),this.text&&a.push(...this.extractText(this.text,e,!0)),e.items))null!=(i=this.grid[s.y])&&null!=(l=i[s.x])&&l.orgItems.unshift(s);for(s of a)null!=(r=this.grid[s.y])&&null!=(h=r[s.x])&&h.items.unshift(s);for(m of this.grid)for(t of m){if(this.hovItem&&t.items.some(e=>e.item===this.hovItem.item)&&(t.color="gray"),this.sel)for(s of(this.sel.hadItems&&this.sel.x0<=(n=t.x)&&n<=this.sel.x1&&this.sel.y0<=(o=t.y)&&o<=this.sel.y1&&(t.bgColor="dark"),t.items))if(s.item&&({item:s}=s),indexOf.call(this.sel.items,s)>=0){t.color="blue";break}t.items.some(e=>e.cursor)&&(t.color="red")}this.setState({})}run(e=this.page){var t,s;this.sel=null,this.timeoutRun?(this.frameIndexRun=-1,this.timeoutRun=clearTimeout(this.timeoutRun),this.animateRun.finish(),this.animateRun=null,this.setPage(this.oldPageRun)):(this.oldPageRun=this.page,this.frameIndexRun="frame"===e.type?this.frames.indexOf(e):0,t=_.sumBy(this.frames.slice(this.frameIndexRun),"duration"),s=this.totalDuration-t,this.animateRun=this.refs.durationRun.animate([{width:`${50*s}px`},{width:`${50*this.totalDuration}px`}],{duration:1e3*t,easing:`steps(${_.round(t/.1,1)}, start)`}),this.handleRun()),this.updateGrid()}handleRun(){var e;(e=this.frames[this.frameIndexRun++])?(this.setPage(e),this.timeoutRun=setTimeout(this.handleRun,1e3*e.duration),this.setState({})):this.run()}componentDidMount(){var e;this.g=this.refs.canvas.getContext("2d"),addEventListener("mousedown",this.onMouseDown,!0),addEventListener("mouseup",this.onMouseUp,!0),addEventListener("keydown",this.onKeyDown,!0),addEventListener("keyup",this.onKeyUp,!0),addEventListener("blur",this.onBlur,!0),addEventListener("contextmenu",this.onContextMenu,!0),this.importData(localStorage.asciite,!0),this.updateTotalDuration(),(e=this.frames[0])?this.setPage(e):this.addFrame()}render(){return React.createElement("div",null,this.page?React.createElement("div",{className:"column full black"},React.createElement("div",{className:"col row"},React.createElement("div",{className:"col column p-5"},React.createElement("div",{className:"flex center middle",style:{minHeight:414}},React.createElement("div",{className:"grid text-mono text-bold leading-1 dark1",style:{gridTemplateColumns:`repeat(${this.page.w}, 1fr)`,fontSize:this.timeoutRun?20:24},onWheel:this.onWheelGrid},this.grid.map(e=>e.map(e=>{var t;return React.createElement("div",{className:classNames([{dark0:!this.timeoutRun},e.bgColor,`text-${e.color}`]),style:{boxShadow:this.timeoutRun?"none":"0 0 0 1px inset #10161a"},onMouseDown:()=>this.mouseDownEnterUpCol(e,!0),onMouseEnter:()=>this.mouseEnterCol(e)},(null!=(t=e.items[0])?t.chr:void 0)||" ")})))),React.createElement("div",{className:"col column"},React.createElement("div",{className:"row middle pt-5 pb-3"},React.createElement("i",{className:"fa fa-cubes mr-4"}),React.createElement("div",{className:"col"},"Mô hình"),React.createElement("button",{onClick:()=>this.addModel()},React.createElement("i",{className:"fa fa-plus mr-4"})," Thêm")),React.createElement("div",{className:"col scroll"},React.createElement("div",{className:"grid-12 gap-2",style:{gridAutoRows:32}},_.map(this.models,e=>React.createElement("div",{className:classNames(["column center middle text-center dark",{blue:this.page===e,"bound-blue":this.tool===e}]),onMouseDown:()=>this.mouseDownModel(e)},React.createElement("img",{src:e.thumbnail}))))))),React.createElement("div",{className:"p-5 column",style:{width:390}},React.createElement("div",{className:"col-6 scroll grid-10 text-mono text-lg text-bold"},this.chrs.map(e=>React.createElement("div",{className:classNames(["flex center middle",{"text-blue":this.tool===e}]),onClick:()=>this.clickChr(e)},e))),React.createElement("div",{className:"col-6 column"},React.createElement("div",{className:"row pb-3"},React.createElement("legend",{className:"mt-5"},React.createElement("span",null,React.createElement("i",{className:"fa fa-list mr-4"})," Thuộc tính"))),React.createElement("div",{className:"col scroll"},React.createElement("div",{className:"row wrap middle fields"},React.createElement("div",{className:"col-6"},"Chiều dài"),React.createElement("input",{ref:"w",className:"col-6 dark",type:"number",readOnly:"frame"===this.page.type,min:1,max:this.w,required:!0,onChange:this.onChangePageW}),React.createElement("div",{className:"col-6"},"Chiều rộng"),React.createElement("input",{ref:"h",className:"col-6 dark",type:"number",readOnly:"frame"===this.page.type,min:1,max:this.h,required:!0,onChange:this.onChangePageH}),this.page.duration?[React.createElement("div",{className:"col-6"},"Thời lượng"),React.createElement("form",{className:"col-6 dark input-group"},React.createElement("label",null,React.createElement("input",{ref:"duration",type:"number",min:.1,max:60,step:.1,required:!0,onChange:this.onChangePageDuration}),React.createElement("span",null,"giây")))]:void 0))))),React.createElement("div",{className:"col-0 column p-5"},React.createElement("div",{className:"row middle pb-3"},React.createElement("i",{className:"fa fa-images mr-4"}),React.createElement("div",{className:"col"},"Khung hình"),React.createElement("div",{className:"col-0 group"},React.createElement("button",{disabled:"frame"!==this.page.type,onClick:()=>this.convertFrameToModel()},React.createElement("i",{className:"fa fa-cube mr-4"})," Chuyển thành mô hình"),React.createElement("button",{disabled:"frame"!==this.page.type,onClick:()=>this.duplicateFrame(null,0)},React.createElement("i",{className:"fa fa-copy mr-4"})," Nhân đôi trái"),React.createElement("button",{disabled:"frame"!==this.page.type,onClick:()=>this.duplicateFrame()},React.createElement("i",{className:"fa fa-copy mr-4"})," Nhân đôi phải"),React.createElement("button",{disabled:"frame"!==this.page.type,onClick:()=>this.addFrame(null,0)},React.createElement("i",{className:"fa fa-plus mr-4"})," Thêm trái"),React.createElement("button",{disabled:"frame"!==this.page.type,onClick:()=>this.addFrame()},React.createElement("i",{className:"fa fa-plus mr-4"})," Thêm phải"),React.createElement("button",{onClick:()=>this.run()},React.createElement("i",{className:`fa fa-${this.timeoutRun?"pause":"play"} mr-4`}),this.timeoutRun?"Dừng":"Phát"))),React.createElement("div",{className:"col column top pb-2 scroll-x"},React.createElement("div",{className:"row relative mb-2"},React.createElement("div",{ref:"durationRun",className:"absolute mb-2 red h-100"}),_.times(Math.max(this.totalDuration+1,innerWidth/50),e=>React.createElement("small",{className:"text-center -transx-50",style:{width:50},children:e}))),React.createElement("div",{className:"row divide-x-black"},this.frames.map((e,t)=>React.createElement("div",{className:classNames(["column center middle py-3 no-events",this.page===e?"blue z-1":"dark no-scroll"]),style:{width:50*e.duration},onMouseDown:()=>this.mouseDownFrame(e)},React.createElement("img",{src:e.thumbnail}),React.createElement("small",null,e.duration))))))):void 0,React.createElement("canvas",{ref:"canvas",hidden:!0}),React.createElement("textarea",{ref:"textarea",onChange:this.onChangeTextarea,onBlur:this.onBlurTextarea}))}},ReactDOM.render(React.createElement(e,null),appEl)}();